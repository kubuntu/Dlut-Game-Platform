#include "jmysqluserinfodb.h"

#include <QTextCodec>
#include <QSqlDatabase>
#include <QSqlQuery>
#include <QSqlDriver>
#include <QVariant>
#include <QSqlRecord>
#include <QSqlError>
#include <QDebug>

JMySQLUserInfoDB::JMySQLUserInfoDB(QSqlDatabase *dgpDB, QObject *parent) :
	JAbstractUserInfoDB(parent), userInfoDB(dgpDB)
{
//	if (!connectCount++) {
//		QTextCodec *codec = QTextCodec::codecForName("UTF-8");
//		QTextCodec::setCodecForCStrings(codec);
//		QTextCodec::setCodecForTr(codec);

//		userInfoDB = new QSqlDatabase;
//		//	userInfoDB->addDatabase("QMYSQL");
//		*userInfoDB = QSqlDatabase::addDatabase("QMYSQL", "userInfoDB");
//		userInfoDB->setHostName("localhost");
//		userInfoDB->setDatabaseName("dgpdb");
//		userInfoDB->setUserName("dgproot");
//		userInfoDB->setPassword("dgproot");
//		if (userInfoDB->open()) {
//			qDebug() << "userInfoDB is open";
//		} else
//			qDebug() << "userInfoDB fail";
//		userInfoDB->exec("SET NAMES 'latin1'");
//	} else {
//		//nothing...
//	}
}

//JMySQLUserInfoDB::~JMySQLUserInfoDB() {
//	if (!--connectCunt) {
//		userInfoDB->close();
//		delete userInfoDB;
//	} else {
//		//nothing...
//	}
//}

JUserInfo JMySQLUserInfoDB::getUserInfoById(JID userID) {
	QSqlQuery *userInfoQuery = new QSqlQuery(*userInfoDB);
	if (userInfoQuery->prepare("SELECT nickname, org FROM user	\n"
							   "WHERE user_id = :userID"))
		qDebug() << "getUserInfoById prepare succ";
	else {
		qDebug() << userInfoQuery->lastError().databaseText();
		qDebug() << "getUserInfoById prepare fail";
	}
	userInfoQuery->bindValue(":userID", userID);
	if (userInfoQuery->exec())
		qDebug() << "getUserInfoById exec succ";
	else {
		qDebug() << userInfoQuery->lastError().databaseText();
		qDebug() << "getUserInfoById exec fail";
	}
	if (userInfoQuery->next())
		return JUserInfo(userID,
						 userInfoQuery->value(0).toString(),
						 userInfoQuery->value(1).toString()
						 );
	else
		return JUserInfo();
}

JCode JMySQLUserInfoDB::updateUserInfo(const JUserInfo &userInfo) {
	QSqlQuery *userInfoQuery = new QSqlQuery(*userInfoDB);
	if (userInfoQuery->prepare("UPDATE user	SET				\n"
									"nickname = :nickname,	\n"
									"org = :org				\n"
							   "WHERE user_id = :userID"))
		qDebug() << "updateUserInfo prepare succ";
	else {
		qDebug() << userInfoQuery->lastError().databaseText();
		qDebug() << "updateUserInfo prepare fail";
	}
	userInfoQuery->bindValue(":nickname", userInfo.getNickname());
	userInfoQuery->bindValue(":org", userInfo.getOrganization());
	userInfoQuery->bindValue(":userID", userInfo.getUserId());
	if (userInfoQuery->exec()) {
		qDebug() << "updateUserInfo exec succ";
		return 0;
	} else {
		qDebug() << userInfoQuery->lastError().databaseText();
		qDebug() << "updateUserInfo exec fail";
		return -1;
	}
}
